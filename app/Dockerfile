# see https://github.com/moby/moby/issues/37345, global arg
ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG SPRING_MAIL_USERNAME
ARG SPRING_MAIL_PASSWORD
ARG SPRING_MAIL_PROPERTIES_MAIL_SMTP_FROM
ARG QINIU_ACCESS_KEY
ARG QINIU_SECRET_KEY
ARG QINIU_BUCKET

FROM maven:3.6.3-jdk-8-slim as build

ENV APP_HOME=/app

WORKDIR $APP_HOME

COPY . $APP_HOME

RUN mvn clean package -Dmaven.test.skip=true

FROM openjdk:8-jdk-alpine

ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG SPRING_MAIL_USERNAME
ARG SPRING_MAIL_PASSWORD
ARG SPRING_MAIL_PROPERTIES_MAIL_SMTP_FROM
ARG QINIU_ACCESS_KEY
ARG QINIU_SECRET_KEY
ARG QINIU_BUCKET

ENV TZ=Asia/Shanghai

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

VOLUME /tmp

COPY --from=build /app/target/*.jar app.jar

EXPOSE 8080

ENV SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL \
    SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME \
    SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD \
    SPRING_MAIL_USERNAME=$SPRING_MAIL_USERNAME \
    SPRING_MAIL_PASSWORD=$SPRING_MAIL_PASSWORD \
    SPRING_MAIL_PROPERTIES_MAIL_SMTP_FROM=$SPRING_MAIL_PROPERTIES_MAIL_SMTP_FROM \
    QINIU_ACCESS_KEY=$QINIU_ACCESS_KEY \
    QINIU_SECRET_KEY=$QINIU_SECRET_KEY \
    QINIU_BUCKET=$QINIU_BUCKET

ENTRYPOINT ["sh", "-c", "java -Dspring.profiles.active=prod -jar /app.jar"]
